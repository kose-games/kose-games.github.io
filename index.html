<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KOSE-GAMES</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="./assets/icon/favicon.png">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span class="logo-text">KOSE GAMES</span>
            </div>
            <ul class="nav-menu">
                <li><a href="#home" class="nav-link">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="#games" class="nav-link">ã‚²ãƒ¼ãƒ </a></li>
                <li><a href="#categories" class="nav-link">ã‚«ãƒ†ã‚´ãƒªãƒ¼</a></li>
                <li><a href="https://suzuri.jp/kosegames" target="_blank" class="nav-link">å…¬å¼ã‚°ãƒƒã‚ºã‚µã‚¤ãƒˆ</a></li>
            </ul>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ã‚²ãƒ¼ãƒ ã‚’æ¤œç´¢...">
                <button class="search-btn">ğŸ”</button>
                <span id="search-status" style="margin-left: 10px; font-size: 12px; color: #666;"></span>
            </div>
        </div>
    </nav>

    <section class="hero" id="home">
        <div class="hero-bg">
            <div class="hero-particles"></div>
        </div>
        <div class="hero-content">
            <h1 class="hero-title">æ¬¡ä¸–ä»£ã®ã‚²ãƒ¼ãƒ ä½“é¨“ã¸</h1>
            <p class="hero-subtitle">æ„›ãŒã‚ã‚‹ã€å†’é™ºãŒã‚ã‚‹ã€äººç”ŸãŒã‚ã‚‹</p>
            <button class="cta-button">ä»Šã™ããƒ—ãƒ¬ã‚¤</button>
        </div>
        <div class="hero-featured">
            <div class="featured-game">
                <div class="featured-img"></div>
                <h3>ã‚µã‚¤ãƒãƒ¼ãƒ‘ãƒ³ã‚¯ãƒ»ã‚ªãƒ‡ãƒƒã‚»ã‚¤</h3>
                <p>æœªæ¥éƒ½å¸‚ã§ç¹°ã‚Šåºƒã’ã‚‰ã‚Œã‚‹å£®å¤§ãªå†’é™º</p>
            </div>
        </div>
    </section>

    <section class="categories" id="categories">
        <div class="container">
            <h2 class="section-title">ã‚«ãƒ†ã‚´ãƒªãƒ¼</h2>
            <div class="category-filter">
                <button class="filter-btn active" data-category="all">ã™ã¹ã¦</button>
                <button class="filter-btn" data-category="action">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</button>
                <button class="filter-btn" data-category="rpg">RPG</button>
                <button class="filter-btn" data-category="puzzle">ãƒ‘ã‚ºãƒ«</button>
                <button class="filter-btn" data-category="strategy">ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼</button>
                <button class="filter-btn" data-category="renai">æ‹æ„›</button>
            </div>
        </div>
    </section>

    <section class="games" id="games">
        <div class="container">
            <h2 class="section-title">ã‚²ãƒ¼ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</h2>
            <div class="games-grid">
                <!-- ã‚²ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                <div class="loading-message" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                    <p style="color: var(--text-gray);">ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>KOSE GAMES</h4>
                    <p>æœ€é«˜ã®ã‚²ãƒ¼ãƒ ä½“é¨“ã‚’ãŠå±Šã‘ã—ã¾ã™</p>
                </div>
                <div class="footer-section">
                    <h4>ãƒªãƒ³ã‚¯</h4>
                    <ul>
                        <li><a href="#">åˆ©ç”¨è¦ç´„</a></li>
                        <li><a href="#">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
                        <li><a href="#">ãŠå•ã„åˆã‚ã›</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>ãƒ•ã‚©ãƒ­ãƒ¼ã™ã‚‹</h4>
                    <div class="social-links">
                        <a href="#" class="social-link">Twitter</a>
                        <a href="#" class="social-link">Instagram</a>
                        <a href="#" class="social-link">YouTube</a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Game Portal. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="games-data.js"></script>
    <script src="ngram-search.js"></script>
    
    <!-- DuckDB WASM for Full-Text Search -->
    <script type="module">
        import * as duckdb from 'https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@latest/+esm';
        
        window.duckDBReady = false;
        window.searchDB = null;
        
        // DuckDB WASMåˆæœŸåŒ–
        async function initializeDuckDB() {
            try {
                const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
                const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);
                
                const workerUrl = URL.createObjectURL(
                    new Blob([`importScripts("${bundle.mainWorker}");`], {type: 'application/javascript'})
                );
                const worker = new Worker(workerUrl);
                
                const logger = new duckdb.ConsoleLogger();
                const db = new duckdb.AsyncDuckDB(logger, worker);
                await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
                
                const conn = await db.connect();
                
                // FTS extension
                console.log('ğŸ“¦ Installing FTS extension...');
                await conn.query(`INSTALL fts;`);
                await conn.query(`LOAD fts;`);
                
                // æ‹¡å¼µæ©Ÿèƒ½ã®ç¢ºèª
                const extensions = await conn.query(`SELECT * FROM duckdb_extensions() WHERE extension_name = 'fts';`);
                const extArray = extensions.toArray();
                console.log('ğŸ“¦ FTS extension status:', extArray.map(row => ({...row})));
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
                await conn.query(`
                    CREATE TABLE IF NOT EXISTS games (
                        id INTEGER PRIMARY KEY,
                        title VARCHAR,
                        category VARCHAR,
                        description VARCHAR,
                        content VARCHAR
                    );
                `);
                
                // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
                if (window.gamesData && window.gamesData.games) {
                    for (const game of window.gamesData.games) {
                        // contentã‚’å°æ–‡å­—åŒ–ã—ã¦ä¿å­˜
                        const content = `${game.title} ${game.description} ${getCategoryName(game.category)}`.toLowerCase();
                        await conn.query(`
                            INSERT INTO games (id, title, category, description, content) 
                            VALUES (${game.id}, '${game.title.replace(/'/g, "''")}', '${game.category}', '${game.description.replace(/'/g, "''")}', '${content.replace(/'/g, "''")}');
                        `);
                    }
                    
                    // FTSã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆå‰ã®ç¢ºèª
                    console.log('ğŸ”¨ Creating FTS index...');
                    
                    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆå‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«çŠ¶æ…‹
                    const beforeTables = await conn.query(`SHOW TABLES;`);
                    console.log('ğŸ“‹ Tables before FTS index:', beforeTables.toArray());
                    
                    // gamesãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ç¢ºèª
                    const tableInfo = await conn.query(`DESCRIBE games;`);
                    console.log('ğŸ“‹ Games table structure:', tableInfo.toArray());
                    
                    try {
                        // æ–¹æ³•1: æ˜ç¤ºçš„ã«overwriteã‚’æŒ‡å®šã€ãƒˆãƒ¼ã‚¯ãƒ³åŒ–è¨­å®šã‚’èª¿æ•´
                        console.log('Creating FTS index with PRAGMA...');
                        await conn.query(`
                            PRAGMA create_fts_index(
                                'games', 
                                'id', 
                                'content', 
                                overwrite=1,
                                stemmer='none',
                                lower=1
                            );
                        `);
                        console.log('âœ… FTS index created successfully');
                        
                        // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
                        const checkIndex = await conn.query(`
                            SELECT COUNT(*) as count FROM duckdb_tables() 
                            WHERE schema_name = 'fts_main_games';
                        `);
                        console.log('FTS tables count:', checkIndex.toArray()[0].count);
                        
                    } catch (e) {
                        console.error('âŒ FTS index creation failed:', e.toString());
                        
                        // æ–¹æ³•2: CALLæ–‡ã‚’ä½¿ã†
                        try {
                            console.log('Trying with CALL statement...');
                            await conn.query(`
                                CALL fts_create_index('games', 'id', 'content');
                            `);
                            console.log('âœ… FTS index created with CALL');
                        } catch (e2) {
                            console.error('âŒ CALL method also failed:', e2.toString());
                        }
                    }
                    
                    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚ŒãŸã‹ç¢ºèª
                    const indexCheck = await conn.query(`SHOW TABLES;`);
                    console.log('ğŸ“Œ Tables after FTS index creation:', indexCheck.toArray());
                    
                    // FTSã‚¹ã‚­ãƒ¼ãƒã®è©³ç´°ç¢ºèª
                    try {
                        const ftsSchemas = await conn.query(`
                            SELECT * FROM duckdb_schemas() 
                            WHERE schema_name LIKE 'fts%';
                        `);
                        console.log('ğŸ” FTS schemas found:', ftsSchemas.toArray());
                        
                        // FTSé–¢é€£ã®é–¢æ•°ç¢ºèª
                        const ftsFunctions = await conn.query(`
                            SELECT * FROM duckdb_functions() 
                            WHERE schema_name LIKE 'fts%' AND function_name = 'match_bm25';
                        `);
                        console.log('ğŸ” FTS match_bm25 functions:', ftsFunctions.toArray());
                    } catch (e) {
                        console.error('FTS schema check error:', e);
                    }
                    
                    // FTSæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
                    try {
                        const testFTS = await conn.query(`
                            SELECT stem('testing', 'porter') as stemmed;
                        `);
                        console.log('ğŸ§ª FTS stem function test:', testFTS.toArray());
                        
                        // FTSã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å­˜åœ¨ã‚’ç¢ºèª
                        const ftsTables = await conn.query(`
                            SELECT table_name FROM duckdb_tables() 
                            WHERE schema_name LIKE 'fts%';
                        `);
                        console.log('ğŸ“„ FTS tables:', ftsTables.toArray().map(t => t.table_name));
                    } catch (e) {
                        console.error('âŒ FTS function test failed:', e.toString());
                    }
                    
                    // N-gramã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
                    if (window.createNgramIndex) {
                        await window.createNgramIndex(conn);
                    }
                }
                
                window.searchDB = conn;
                window.duckDBReady = true;
                console.log('ğŸ¦† DuckDB FTS initialized successfully');
                console.log('ğŸ“Š Games loaded into DuckDB:', window.gamesData.games.length);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®è¡¨ç¤º
                const statusEl = document.getElementById('search-status');
                if (statusEl) {
                    statusEl.textContent = 'âœ… é«˜é€Ÿæ¤œç´¢æº–å‚™å®Œäº†';
                    statusEl.style.color = '#22c55e';
                    setTimeout(() => {
                        statusEl.textContent = '';
                    }, 3000);
                }
                
                // ãƒ†ã‚¹ãƒˆæ¤œç´¢ã‚’å®Ÿè¡Œ
                const testResult = await conn.query(`SELECT COUNT(*) as count FROM games;`);
                console.log('ğŸ” Test query result:', testResult.toArray());
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«ã®å†…å®¹ã‚’ç¢ºèª
                const contentCheck = await conn.query(`SELECT id, title, content FROM games;`);
                console.log('ğŸ“‹ Table content:', contentCheck.toArray());
                
                // FTSã‚¹ã‚­ãƒ¼ãƒã®ç¢ºèª
                try {
                    const schemas = await conn.query(`SELECT * FROM duckdb_schemas() WHERE database_name = 'memory' AND schema_name LIKE 'fts%';`);
                    console.log('ğŸ“ FTS schemas:', schemas.toArray());
                } catch (e) {
                    console.error('Schema check error:', e);
                }
                
                // æ¤œç´¢æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
                enableSearch();
                
            } catch (error) {
                console.error('Failed to initialize DuckDB:', error);
            }
        }
        
        // ã‚«ãƒ†ã‚´ãƒªåå–å¾—
        function getCategoryName(category) {
            const categories = {
                'action': 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³',
                'rpg': 'RPG',
                'puzzle': 'ãƒ‘ã‚ºãƒ«',
                'strategy': 'ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼',
                'renai': 'æ‹æ„›'
            };
            return categories[category] || category;
        }
        
        // å…¨æ–‡æ¤œç´¢å®Ÿè¡Œï¼ˆN-gramãƒ™ãƒ¼ã‚¹ï¼‰
        window.performFullTextSearch = async function(searchTerm) {
            if (!window.duckDBReady || !window.searchDB) {
                console.log('DuckDB not ready, falling back to simple search');
                return null;
            }
            
            try {
                console.log('ğŸ” Searching with n-grams for:', searchTerm);
                
                // N-gramæ¤œç´¢ã‚’ä½¿ç”¨
                if (window.searchWithNgrams) {
                    const results = await window.searchWithNgrams(window.searchDB, searchTerm);
                    console.log('N-gram search results:', results);
                    return results;
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé€šå¸¸ã®LIKEæ¤œç´¢
                const lowerSearchTerm = searchTerm.toLowerCase();
                const result = await window.searchDB.query(`
                    SELECT 
                        id,
                        title,
                        category,
                        description,
                        1.0 as score
                    FROM games
                    WHERE 
                        LOWER(title) LIKE '%${lowerSearchTerm.replace(/'/g, "''")}%' OR
                        LOWER(description) LIKE '%${lowerSearchTerm.replace(/'/g, "''")}%'
                    ORDER BY title;
                `);
                
                return result.toArray();
            } catch (error) {
                console.error('Search error:', error);
                return null;
            }
        };
        
        // æ¤œç´¢æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
        function enableSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.querySelector('.search-btn');
            
            if (searchInput) {
                searchInput.placeholder = "å…¨æ–‡æ¤œç´¢ã§ã‚²ãƒ¼ãƒ ã‚’æ¢ã™...";
            }
        }
        
        // ç°¡å˜ãªFTSãƒ†ã‚¹ãƒˆé–¢æ•°
        window.simpleFTSTest = async function() {
            if (!window.searchDB) {
                console.error('DuckDB not initialized');
                return;
            }
            
            console.log('=== Simple FTS Test ===');
            
            try {
                // 1. æ–°ã—ã„ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
                await window.searchDB.query(`DROP TABLE IF EXISTS test_fts;`);
                await window.searchDB.query(`
                    CREATE TABLE test_fts (
                        id INTEGER,
                        text VARCHAR
                    );
                `);
                
                // 2. ãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥
                await window.searchDB.query(`
                    INSERT INTO test_fts VALUES 
                    (1, 'ã“ã›ã¯æ¥½ã—ã„ã‚²ãƒ¼ãƒ ã§ã™'),
                    (2, 'ãƒ‘ã‚ºãƒ«ã‚²ãƒ¼ãƒ ãŒå¤§å¥½ã'),
                    (3, 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ ã‚‚é¢ç™½ã„');
                `);
                
                // 3. FTSã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
                await window.searchDB.query(`
                    PRAGMA create_fts_index('test_fts', 'id', 'text');
                `);
                
                // 4. ãƒ†ãƒ¼ãƒ–ãƒ«ç¢ºèª
                const tables = await window.searchDB.query(`SHOW TABLES;`);
                console.log('Tables after test FTS index:', tables.toArray());
                
                // 5. FTSæ¤œç´¢ã‚’è©¦ã™
                const searchResult = await window.searchDB.query(`
                    SELECT *, fts_main_test_fts.match_bm25(id, 'ã‚²ãƒ¼ãƒ ') as score
                    FROM test_fts
                    WHERE score IS NOT NULL
                    ORDER BY score DESC;
                `);
                console.log('Test FTS search results:', searchResult.toArray());
                
            } catch (error) {
                console.error('Simple FTS test error:', error.toString());
            }
        };
        
        // DuckDBåˆæœŸåŒ–é–‹å§‹
        initializeDuckDB();
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.testFTS = async function(searchTerm = 'ã“ã›') {
            if (!window.searchDB) {
                console.error('DuckDB not initialized');
                return;
            }
            
            console.log('=== FTS Debug Test ===');
            console.log('Search term:', searchTerm);
            
            try {
                // 1. ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
                const tables = await window.searchDB.query(`SHOW TABLES;`);
                console.log('Tables:', tables.toArray().map(t => t.name));
                
                // 2. gamesãƒ†ãƒ¼ãƒ–ãƒ«ã®å†…å®¹ç¢ºèª
                const games = await window.searchDB.query(`SELECT * FROM games LIMIT 5;`);
                console.log('Games table sample:', games.toArray());
                
                // 3. FTSã‚¹ã‚­ãƒ¼ãƒã®ç¢ºèª
                const schemas = await window.searchDB.query(`SELECT * FROM duckdb_schemas();`);
                console.log('All schemas:', schemas.toArray());
                
                // 4. é€šå¸¸ã®LIKEæ¤œç´¢
                const likeResult = await window.searchDB.query(`
                    SELECT id, title, content 
                    FROM games 
                    WHERE content LIKE '%${searchTerm}%';
                `);
                console.log('LIKE search results:', likeResult.toArray());
                
                // 5. FTSæ¤œç´¢ã‚’è©¦ã™ï¼ˆè¤‡æ•°ã®æ–¹æ³•ï¼‰
                console.log('--- Testing FTS search methods ---');
                
                // æ–¹æ³•1: WHEREå¥ãªã—ã§è©¦ã™
                try {
                    const ftsResult1 = await window.searchDB.query(`
                        SELECT *, fts_main_games.match_bm25(id, '${searchTerm}') as score
                        FROM games;
                    `);
                    console.log('Method 1 - FTS without WHERE:', ftsResult1.toArray());
                } catch (e) {
                    console.error('Method 1 error:', e.toString());
                }
                
                // æ–¹æ³•2: ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ã†
                try {
                    const ftsResult2 = await window.searchDB.query(`
                        SELECT * FROM (
                            SELECT *, fts_main_games.match_bm25(id, '${searchTerm}') as score
                            FROM games
                        ) WHERE score IS NOT NULL;
                    `);
                    console.log('Method 2 - FTS with subquery:', ftsResult2.toArray());
                } catch (e) {
                    console.error('Method 2 error:', e.toString());
                }
                
                // æ–¹æ³•3: ç›´æ¥ãƒã‚¯ãƒ­ã‚’å‘¼ã¶
                try {
                    const ftsResult3 = await window.searchDB.query(`
                        SELECT fts_main_games.match_bm25(${1}, '${searchTerm}') as score;
                    `);
                    console.log('Method 3 - Direct macro call:', ftsResult3.toArray());
                } catch (e) {
                    console.error('Method 3 error:', e.toString());
                }
                
                // FTSé–¢æ•°/ãƒã‚¯ãƒ­ã®ç¢ºèª
                try {
                    const macros = await window.searchDB.query(`
                        SELECT * FROM duckdb_functions() 
                        WHERE function_name LIKE '%match%' OR function_name LIKE '%fts%';
                    `);
                    console.log('FTS-related functions/macros:', macros.toArray());
                } catch (e) {
                    console.error('Function check error:', e);
                }
                
            } catch (error) {
                console.error('Debug test error:', error);
            }
        };
    </script>
    
    <script src="script.js"></script>
</body>
</html>
